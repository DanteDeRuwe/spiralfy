@using Piral.Blazor.Utils
@using Microsoft.Extensions.Logging
@using Spiralfy.Core
@using Spiralfy.Core.Interfaces
@using Spiralfy.Core.Utils
@attribute [PiralExtension("header-items")]

@inject NavigationManager _navManager
@inject ILogger<Login> _logger;

@if(!_isAuthed)
{
    <a href="@_authUri" class="Button" data-primary="true">Login via Spotify</a>
}
else
{
    <p>Welcome @_username</p>
}


@code {
    private Uri _authUri;
    private bool _isAuthed;
    private string _username;
    private ISpiralfyService _service;

    protected override async Task OnInitializedAsync()
    {
        var fragmentDict = new Uri(_navManager.Uri).ToFragmentDict();
        _isAuthed = fragmentDict.ContainsKey("access_token");

        if (!_isAuthed)
        {
            var redirectUri = _navManager.ToAbsoluteUri(_navManager.BaseUri);
            var loginRequest = new LoginRequest(redirectUri, "a8e9b67342b740479fcb00609a46d354", LoginRequest.ResponseType.Token)
            {
                Scope = new[] { Scopes.UserModifyPlaybackState, Scopes.UserReadCurrentlyPlaying, Scopes.UserReadPlaybackState, Scopes.UserReadPlaybackPosition }
            };
            _authUri = loginRequest.ToUri();
        }
        else
        {
            var spotify = new SpotifyClient(fragmentDict["access_token"]);
            _service = new SpiralfyService(spotify);
            _username = (await _service.GetCurrentUser()).DisplayName;
        }
    }
}
